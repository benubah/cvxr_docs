---
title: Near Isotonic and Near Convex Regression
author: Anqi Fu and Balasubramanian Narasimhan
date: '2017-11-02'
slug: near-isotonic-and-near-convex-regression
bibliography: cvxr_refs.bib
link-citations: true
categories: []
tags: []
---

Given a set of data points $y \in {\mathbf R}^m$,
@TibshiraniHoefling:2011 fit a nearly-isotonic approximation $\beta
\in {\mathbf R}^m$ by solving
$$
\begin{array}{ll}

\underset{\beta}{\mbox{minimize}} & \frac{1}{2}\sum_{i=1}^m (y_i -
\beta_i)^2 + \lambda \sum_{i=1}^{m-1}(\beta_i - \beta_{i+1})_+,

\end{array}
$$
where $\lambda \geq 0$ is a penalty parameter and $x_+
=\max(x,0)$. This can be directly formulated in `cvxr`.  As an
example, we use global warming data from
the
[Carbon Dioxide Information Analysis Center (CDIAC)](http://cdiac.ess-dive.lbl.gov/ftp/trends/temp/jonescru/). The
data points are the annual temperature anomalies relative to the
1961--1990 mean.

```{r}
library(readr)
cdiac_url <- "http://cdiac.ess-dive.lbl.gov/ftp/trends/temp/jonescru/global.txt"
CDIAC <- read_table(file = cdiac_url, skip=16)[, c("YEAR", "ANNUAL")]
str(CDIAC)
```

We plan to not only fit the regression, but also get some idea of the
standard errors, so we write a function that computes the fit for use
in bootstrapping. (We use a small number of bootstrap samples here as
the fits are time consuming.)

```{r}
suppressMessages(suppressWarnings(library(cvxr)))
neariso_fit <- function(y, lambda) {
    m <- length(y)
    beta <- Variable(m)
    penalty <- sum(pos(diff(beta)))
    obj <- 0.5 * sum((y - beta)^2) + lambda * sum(pos(diff(beta)))
    prob <- Problem(Minimize(obj))
    solve(prob)$getValue(beta)
}
```
The `pos` atom evaluates $x_+$ elementwise on the input expression.

We will use the `boot` library for bootstrapping which requires
passing the data frame and the bootstrap indices and a statistic
function that computes the fit.

```{r}
neariso_fit_stat <- function(data, index, lambda) {
    sample <- data[index,]                  # Bootstrap sample of rows
    sample <- sample[order(sample$YEAR),]   # Order ascending by year
    neariso_fit(sample$ANNUAL, lambda)
}
```

```{r}
library(boot)

boot.neariso <- boot(data = CDIAC, statistic = neariso_fit_stat, R = 10, lambda = 0.44)

ci.neariso <- t(sapply(seq_len(nrow(CDIAC)),
                            function(i) boot.ci(boot.out = boot.neariso, conf = 0.95,
                                                type = "norm", index = i)$normal[-1]))
data.neariso <- data.frame(year = CDIAC$YEAR, annual = CDIAC$ANNUAL, est = boot.neariso$t0,
                              lower = ci.neariso[, 1], upper = ci.neariso[, 2])
```

We can now plot the fit and confidence bands for the near isotonic
fit. 

```{r}
library(ggplot2)
(plot.neariso <- ggplot(data = data.neariso) +
     geom_point(mapping = aes(year, annual), color = "red") +
     geom_line(mapping = aes(year, est), color = "blue") +
     geom_ribbon(mapping = aes(x = year, ymin = lower,ymax = upper),alpha=0.3) +
     labs(x = "Year", y = "Temperature Anomalies")
)
```

For a smoother curve, we can solve for the nearly-convex fit described
in the same paper: 

$$
\begin{array}{ll}
\underset{\beta}{\mbox{minimize}} & \frac{1}{2}\sum_{i=1}^m (y_i -
\beta_i)^2 + \lambda \sum_{i=1}^{m-2}(\beta_i - 2\beta_{i+1} +
\beta_{i+2})_+ \end{array} 
$$

This replaces the first difference term with an approximation to the
second derivative at $\beta_{i+1}$. In `cvxr`, the only change
necessary is the penalty line: replacing `diff(x)` by `diff(diff(x))`.

```{r}
nearconvex_fit <- function(y, lambda) {
    m <- length(y)
    beta <- Variable(m)
    penalty <- sum(pos(diff(beta)))
    obj <- 0.5 * sum((y - beta)^2) + lambda * sum(pos(diff(diff(beta))))
    prob <- Problem(Minimize(obj))
    solve(prob)$getValue(beta)
}

nearconvex_fit_stat <- function(data, index, lambda) {
    sample <- data[index,]                  # Bootstrap sample of rows
    sample <- sample[order(sample$YEAR),]   # Order ascending by year
    nearconvex_fit(sample$ANNUAL, lambda)
}

boot.nearconvex <- boot(data = CDIAC, statistic = nearconvex_fit_stat, R = 5, lambda = 0.44)

ci.nearconvex <- t(sapply(seq_len(nrow(CDIAC)),
                          function(i) boot.ci(boot.out = boot.nearconvex, conf = 0.95,
                                              type = "norm", index = i)$normal[-1]))
data.nearconvex <- data.frame(year = CDIAC$YEAR, annual = CDIAC$ANNUAL, est = boot.nearconvex$t0,
                              lower = ci.nearconvex[, 1], upper = ci.nearconvex[, 2])

```

The resulting curve for the near convex fit is depicted below with
95\% confidence bands generated from $R = 5$ samples. Note the jagged
staircase pattern has been smoothed out. We can easily extend this
example to higher-order differences or lags. To make this easy, the function `diff` takes
an argument `differences` is by default 1; a third-order difference is
specified as `diff(x, differences = 3)`.

```{r}
(plot.nearconvex <- ggplot(data = data.nearconvex) +
     geom_point(mapping = aes(year, annual), color = "red") +
     geom_line(mapping = aes(year, est), color = "blue") +
     geom_ribbon(mapping = aes(x = year, ymin = lower,ymax = upper),alpha=0.3) +
     labs(x = "Year", y = "Temperature Anomalies")
)
```

## References
